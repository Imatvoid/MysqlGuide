

# 分库分表

一般来讲,将库进行垂直拆分和水平拆分后,在将表进行合理的垂直拆分就够了.不建议对表进行水平拆分.



## 库拆分

### 垂直拆分

按业务分库,比如order库,goods商品库

### 水平拆分

比如将order库再拆分,order1-order32个库,规则比如orderId字段(Long) 向右移动42位.即是在第几个库.

比如4418858115632是在order1库.

> 这里可以算一下,Long64,低42位代表实际id,2的42次方43980亿,就算一天1亿订单的话,43980/360=122
>
> 可以使用100多年.如果单子类型不同,建议加不同的前缀,并且垂直分到不同数据库.



## 表拆分

### 垂直拆分

垂直拆分是指数据表**列的拆分**，把一张列比较多的表拆分为多张表

![image-20190528112856377](分库分表/image-20190528112856377.png)

通常我们按以下原则进行垂直拆分:

1. 把不常用的字段单独放在一张表;
2. 把text，blob等大字段拆分出来放在附表中;
3. 经常组合查询的列放在一张表中;

> 垂直拆分更多时候就应该在数据表设计之初就执行的步骤，然后查询的时候用jion关键起来即可;

### 水平拆分

水平拆分是指数据表**行的拆分**，表的行数超过200万行时，就会变慢，这时可以把一张的表的数据拆成多张表来存放。

![image-20190528113220654](分库分表/image-20190528113220654.png)

### 水平拆分的一些技巧

**1. 拆分原则**
通常情况下，我们使用取模的方式来进行表的拆分;比如一张有400W的用户表`users`，为提高其查询效率我们把其分成4张表`users1，users2，users3，users4`
通过用ID取模的方法把数据分散到四张表内`Id%4+1 = [1,2,3,4]`
然后查询,更新,删除也是通过取模的方法来查询

```sql
$_GET['id'] = 17,
17%4 + 1 = 2,  
$tableName = 'users'.'2'
Select * from users2 where id = 17;
```

在insert时还需要一张临时表`uid_temp`来提供自增的ID,该表的唯一用处就是提供自增的ID;

```sql
insert into uid_temp values(null);
```

得到自增的ID后,又通过取模法进行分表插入;

> 注意,进行水平拆分后的表,字段的列和类型和原表应该是相同的,但是要记得去掉auto_increment自增长

**另外**

- 部分业务逻辑也可以通过地区，年份等字段来进行归档拆分;
- 进行拆分后的表，只能满足部分查询的高效查询需求，这时我们就要在产品策划上，从界面上约束用户查询行为。比如我们是按年来进行归档拆分的,这个时候在页面设计上就约束用户必须要先选择年,然后才能进行查询;
- 在做分析或者统计时，由于是自己人的需求,多点等待其实是没关系的,并且并发很低,这个时候可以用union把所有表都组合成一张视图来进行查询,然后再进行查询;





## 参考

https://juejin.im/entry/5b5eb7f2e51d4519700f7d3c

https://www.kancloud.cn/thinkphp/mysql-design-optimalize/39326